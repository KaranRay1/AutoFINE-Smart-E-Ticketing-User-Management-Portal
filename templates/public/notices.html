{% extends "base.html" %}

{% block title %}Traffic Notices - AutoFINE{% endblock %}

{% block content %}
<div class="main-content-professional animate-fade-in-professional" style="background: #ffffff;">
  <h2 class="mb-3" style="color: var(--navy-blue); font-weight: 700;">
    <i class="bi bi-megaphone challan-icon"></i> Traffic Notices
  </h2>
  <div style="color: var(--text-medium);" class="mb-3">State and Central government notices (demo feed, AI-refreshable).</div>

  <div class="d-flex gap-2 mb-4">
    <button class="btn-professional btn-professional-primary" type="button" onclick="refreshNoticesAI()">
      <i class="bi bi-stars"></i> Refresh Notices (AI)
    </button>
    <small class="text-muted align-self-center">AI notices are generated by Gemini; for true “internet real-time”, a live govt feed API is required.</small>
  </div>

  <div class="row g-3" id="notices-container">
    {% for n in notices %}
      <div class="col-md-6">
        <div class="card-professional">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">{{ n.title }}</h5>
              <span class="badge-professional {% if n.scope == 'Central' %}badge-professional-primary{% else %}badge-professional-warning{% endif %}">
                {{ n.scope }}
              </span>
            </div>
            <div style="color: var(--text-medium); font-size: 0.85rem;">
              {{ (n.state or 'India') }}{% if n.city %} • {{ n.city }}{% endif %} • {{ n.published_at.strftime('%Y-%m-%d') }}
            </div>
          </div>
          <div class="card-body">
            <div style="color: var(--text-dark);">{{ n.body }}</div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
async function refreshNoticesAI() {
  const container = document.getElementById('notices-container');
  container.innerHTML = `
    <div class="col-12 text-center">
      <div class="spinner-professional"></div>
      <p class="text-muted">Loading AI notices...</p>
    </div>
  `;
  try {
    const res = await fetch('/api/gemini/notices');
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed to load');
    const notices = data.notices || [];
    container.innerHTML = notices.map(n => `
      <div class="col-md-6">
        <div class="card-professional">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">${escapeHtml(n.title || 'Traffic Notice')}</h5>
              <span class="badge-professional ${n.scope === 'Central' ? 'badge-professional-primary' : 'badge-professional-warning'}">
                ${escapeHtml(n.scope || 'Central')}
              </span>
            </div>
            <div style="color: var(--text-medium); font-size: 0.85rem;">
              ${(n.state || 'India')}${n.city ? ' • ' + escapeHtml(n.city) : ''} • ${escapeHtml(n.published_at || '')}
            </div>
          </div>
          <div class="card-body">
            <div style="color: var(--text-dark);">${escapeHtml(n.body || '')}</div>
          </div>
        </div>
      </div>
    `).join('');
  } catch (e) {
    container.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error: ${escapeHtml(e.message)}</div></div>`;
  }
}

function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
</script>
{% endblock %}

